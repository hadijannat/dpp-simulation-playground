version: '3.8'
services:
  frontend:
    build: ../../frontend
    ports: ["3000:3000"]
    environment:
      - VITE_API_URL=http://localhost:8000
    depends_on:
      - api-gateway

  api-gateway:
    build: ../kong
    ports: ["8000:8000", "8443:8443"]
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: dpp

  simulation-engine:
    build:
      context: ../..
      dockerfile: services/simulation-engine/Dockerfile
    ports: ["8101:8001"]
    environment:
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=dpp
      - AUTH_MODE=auto
      - DEV_BYPASS_AUTH=true
      - SERVICE_CLIENT_ID=dpp-services
      - SERVICE_CLIENT_SECRET=dev-services-secret
      - DATABASE_URL=postgresql://dpp:dpp@postgres:5432/dpp_playground
      - REDIS_URL=redis://redis:6379/0
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_BUCKET=dpp-aasx
      - MINIO_PUBLIC_URL=http://localhost:9100
    depends_on: [postgres, redis, mongodb, keycloak]

  compliance-service:
    build:
      context: ../..
      dockerfile: services/compliance-service/Dockerfile
    ports: ["8102:8002"]
    environment:
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=dpp
      - AUTH_MODE=auto
      - DEV_BYPASS_AUTH=true
      - DATABASE_URL=postgresql://dpp:dpp@postgres:5432/dpp_playground
      - REDIS_URL=redis://redis:6379/0
    depends_on: [keycloak]

  gamification-service:
    build:
      context: ../..
      dockerfile: services/gamification-service/Dockerfile
    ports: ["8103:8003"]
    environment:
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=dpp
      - AUTH_MODE=auto
      - DEV_BYPASS_AUTH=true
      - DATABASE_URL=postgresql://dpp:dpp@postgres:5432/dpp_playground
      - REDIS_URL=redis://redis:6379/0
    depends_on: [postgres, redis, keycloak]

  edc-simulator:
    build:
      context: ../..
      dockerfile: services/edc-simulator/Dockerfile
    ports: ["8104:8004"]
    environment:
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=dpp
      - AUTH_MODE=auto
      - DEV_BYPASS_AUTH=true
      - DATABASE_URL=postgresql://dpp:dpp@postgres:5432/dpp_playground
      - REDIS_URL=redis://redis:6379/0
    depends_on: [keycloak]

  collaboration-service:
    build:
      context: ../..
      dockerfile: services/collaboration-service/Dockerfile
    ports: ["8105:8005"]
    environment:
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=dpp
      - AUTH_MODE=auto
      - DEV_BYPASS_AUTH=true
      - DATABASE_URL=postgresql://dpp:dpp@postgres:5432/dpp_playground
      - REDIS_URL=redis://redis:6379/0
    depends_on: [keycloak]

  keycloak:
    build: ../keycloak
    ports: ["8080:8080"]
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
    command: start-dev --import-realm

  aas-environment:
    image: eclipsebasyx/aas-environment:2.0.0-SNAPSHOT
    ports: ["8281:8081"]
    depends_on: [mongodb]

  aas-registry:
    image: eclipsebasyx/aas-registry-log-mongodb:2.0.0-SNAPSHOT
    ports: ["8082:8080"]

  submodel-registry:
    image: eclipsebasyx/aas-registry-log-mongodb:2.0.0-SNAPSHOT
    ports: ["8083:8080"]

  postgres:
    image: postgres:16
    environment:
      - POSTGRES_DB=dpp_playground
      - POSTGRES_USER=dpp
      - POSTGRES_PASSWORD=dpp
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7.2-alpine

  mongodb:
    image: mongo:7.0

  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    ports: ["9100:9000", "9101:9001"]

volumes:
  postgres_data:
